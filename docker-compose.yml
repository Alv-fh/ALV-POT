#!/bin/bash

# Honeypot Stack Setup - VersiÃ³n corregida
# By: ALV-POT

set -e

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print() { echo -e "${GREEN}[+]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[x]${NC} $1"; }
info() { echo -e "${BLUE}[i]${NC} $1"; }

# Directorio actual
BASE_DIR="$(pwd)"

# Verificar Docker
check_docker() {
    if ! command -v docker &> /dev/null; then
        error "Docker no encontrado"
        info "Instala con: sudo apt install docker.io docker-compose"
        exit 1
    fi
    
    if ! docker info &> /dev/null; then
        if ! sudo docker info &> /dev/null; then
            error "Docker no estÃ¡ ejecutÃ¡ndose"
            info "Inicia con: sudo systemctl start docker"
            exit 1
        else
            print "Docker funcionando (con sudo)"
        fi
    else
        print "âœ“ Docker funcionando"
    fi
}

# Configurar sistema
configure_system() {
    print "Configurando sistema..."
    
    # Memoria para Elasticsearch
    sudo sysctl -w vm.max_map_count=262144 2>/dev/null || warn "No se pudo configurar sysctl"
    
    # Verificar espacio
    FREE_SPACE=$(df -h . | awk 'NR==2 {print $4}')
    print "Espacio libre: $FREE_SPACE"
}

# Crear estructura
create_structure() {
    print "Creando estructura de directorios..."
    
    # Directorios de datos
    mkdir -p data/elasticsearch
    mkdir -p data/cowrie/{downloads,log,keys}
    mkdir -p data/dionaea/{log,lib}
    mkdir -p data/rdpy/logs
    mkdir -p data/dvwa/mysql
    mkdir -p data/dvwa/logs
    
    # Configuraciones
    mkdir -p config
    
    # Permisos
    chmod 777 data/elasticsearch 2>/dev/null || true
    
    print "âœ“ Estructura creada"
}

# Descargar imÃ¡genes
pull_images() {
    print "Descargando imÃ¡genes Docker..."
    
    # Lista de imÃ¡genes
    local images=(
        "elasticsearch:8.11.0"
        "kibana:8.11.0"
        "logstash:8.11.0"
        "cowrie/cowrie:latest"
        "ghcr.io/dtag-dev-sec/dionaea:latest"
        "amazedostrich/rdpy:latest"
        "mariadb:10.6"
        "vulnerables/web-dvwa:latest"
    )
    
    for image in "${images[@]}"; do
        print "Descargando: $image"
        docker pull "$image" 2>/dev/null || sudo docker pull "$image" || warn "Error descargando $image"
    done
    
    print "âœ“ ImÃ¡genes descargadas"
}

# Iniciar servicios
start_services() {
    print "Iniciando servicios..."
    
    # Parar si ya estÃ¡ corriendo
    docker-compose down 2>/dev/null || sudo docker-compose down 2>/dev/null || true
    
    # Iniciar en orden
    print "1. Iniciando Elasticsearch..."
    docker-compose up -d elasticsearch || sudo docker-compose up -d elasticsearch
    
    # Esperar a ES
    info "Esperando a Elasticsearch (30 segundos)..."
    sleep 30
    
    print "2. Iniciando Kibana..."
    docker-compose up -d kibana || sudo docker-compose up -d kibana
    
    print "3. Iniciando honeypots..."
    docker-compose up -d cowrie dionaea rdpy dvwa-mysql dvwa-web logstash || \
    sudo docker-compose up -d cowrie dionaea rdpy dvwa-mysql dvwa-web logstash
    
    print "âœ“ Todos los servicios iniciados"
}

# Verificar servicios
check_services() {
    print "Verificando servicios..."
    sleep 10
    
    echo ""
    info "=== ESTADO DE SERVICIOS ==="
    
    # Elasticsearch
    if curl -s http://localhost:9200 > /dev/null 2>&1; then
        print "âœ“ Elasticsearch: http://localhost:9200"
    else
        warn "âš  Elasticsearch: No responde (espera 1-2 min)"
    fi
    
    # Kibana
    if curl -s http://localhost:5601 > /dev/null 2>&1; then
        print "âœ“ Kibana: http://localhost:5601"
    else
        warn "âš  Kibana: Iniciando..."
    fi
    
    # Honeypots
    print "âœ“ Honeypots escuchando en:"
    print "  - SSH/Telnet: localhost:2222-2223"
    print "  - FTP: localhost:21"
    print "  - RDP: localhost:3389"
    print "  - DVWA: http://localhost"
    print "  - MySQL: localhost:3306"
    
    echo ""
    info "=== COMANDOS ÃšTILES ==="
    print "  Ver estado:   docker-compose ps"
    print "  Ver logs:     docker-compose logs [nombre]"
    print "  Detener:      ./setup.sh stop"
    print "  Limpiar:      ./setup.sh cleanup"
}

# Comandos
case "$1" in
    start)
        print "ðŸš€ INICIANDO ALV-POT HONEYPOT STACK"
        echo ""
        
        check_docker
        configure_system
        create_structure
        pull_images
        start_services
        check_services
        ;;
        
    stop)
        print "ðŸ›‘ Deteniendo servicios..."
        docker-compose down 2>/dev/null || sudo docker-compose down
        print "âœ“ Servicios detenidos"
        ;;
        
    status)
        docker-compose ps 2>/dev/null || sudo docker-compose ps
        ;;
        
    logs)
        docker-compose logs -f 2>/dev/null || sudo docker-compose logs -f
        ;;
        
    cleanup)
        warn "âš  ESTO ELIMINARÃ TODOS LOS DATOS"
        read -p "Â¿Continuar? (escribe 'si'): " confirm
        if [ "$confirm" = "si" ]; then
            docker-compose down -v 2>/dev/null || sudo docker-compose down -v
            rm -rf data
            print "âœ“ Todo eliminado"
        else
            print "OperaciÃ³n cancelada"
        fi
        ;;
        
    help|--help|-h|"")
        echo -e "${BLUE}ALV-POT Honeypot Stack${NC}"
        echo ""
        echo "Comandos:"
        echo "  ./setup.sh start     - Iniciar stack completo"
        echo "  ./setup.sh stop      - Detener todo"
        echo "  ./setup.sh status    - Ver estado"
        echo "  ./setup.sh logs      - Ver logs"
        echo "  ./setup.sh cleanup   - Eliminar todo (datos incluidos)"
        echo "  ./setup.sh help      - Mostrar ayuda"
        ;;
        
    *)
        error "Comando desconocido: $1"
        ./setup.sh help
        exit 1
        ;;
esac

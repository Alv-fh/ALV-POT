input {
  # --- Cowrie ---
  file {
    path => "/var/log/cowrie/cowrie.json"
    codec => json
    type => "cowrie"
    start_position => "beginning"
  }

  # --- DVWA (Apache) ---
  file {
    path => "/var/log/dvwa/access.log"
    type => "dvwa-access"
    start_position => "beginning"
  }
  
  # --- DVWA (Error) ---
  file {
    path => "/var/log/dvwa/error.log"
    type => "dvwa-error"
    start_position => "beginning"
  }

  # --- RDPY ---
  file {
    path => "/var/log/rdpy/rdpy.log"  
    type => "rdpy"
    start_position => "beginning"
    sincedb_path => "/dev/null"  
  }
}


filter {
  # Normalizacion de Fechas para Cowrie
  if [type] == "cowrie" {
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
  }

  # --- FILTRO PARA RDPY ---
  if [type] == "rdpy" {
    if [message] =~ "^\d{4}-\d{2}-\d{2}T" {
      csv {
        columns => ["timestamp", "event_type", "source_ip", "source_port", "details"]
        separator => ","
        skip_empty_columns => true
      }
      date {
        match => [ "timestamp", "ISO8601" ]
        target => "@timestamp"
      }
    }
    # Para líneas con formato INFO: [*] INFO: ...
    else if [message] =~ "\[\*\] INFO:" {
      grok {
        match => { "message" => "\[\*\] INFO:\s+%{GREEDYDATA:rdpy_message}" }
      }
    }
    # Para logs de autenticación (domain:,username:, etc.)
    else if [message] =~ "domain:" {
      kv {
        source => "message"
        field_split => ","
        value_split => ":"
        trim_key => " "
        trim_value => " "
      }
    }
  }

  # Parseo de logs de Apache (DVWA)
  if [type] == "dvwa-access" {
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
    }
    date {
      match => [ "timestamp" , "dd/MMM/yyyy:HH:mm:ss Z" ]
    }
  }
}

output {
  if [type] == "cowrie" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "logstash-cowrie-%{+YYYY.MM.dd}"
    }
  }
  else if [type] == "rdpy" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "logstash-rdpy-%{+YYYY.MM.dd}"  
    }
  }
  else {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "logstash-others-%{+YYYY.MM.dd}"
    }
  }
}

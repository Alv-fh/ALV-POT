input {
  # --- Cowrie ---
  file {
    path => "/var/log/cowrie/cowrie.json"
    codec => json
    type => "cowrie"
    start_position => "beginning"
  }

  # --- Dionaea ---
  file {
    path => "/var/log/dionaea/dionaea.json"
    codec => json
    type => "dionaea"
    start_position => "beginning"
  }

  # --- DVWA (Apache) ---
  file {
    path => "/var/log/dvwa/access.log"
    type => "dvwa-access"
    start_position => "beginning"
  }
  
  # --- DVWA (Error) ---
  file {
    path => "/var/log/dvwa/error.log"
    type => "dvwa-error"
    start_position => "beginning"
  }
}

filter {
  # Normalización de Fechas para Cowrie
  if [type] == "cowrie" {
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
    # T-Pot suele añadir GeoIP aquí, pero requiere bases de datos extra.
    # Por ahora lo dejamos simple.
  }

  # Normalización de Fechas para Dionaea
  if [type] == "dionaea" {
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
  }

  # Parseo de logs de Apache (DVWA)
  if [type] == "dvwa-access" {
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
    }
    date {
      match => [ "timestamp" , "dd/MMM/yyyy:HH:mm:ss Z" ]
    }
  }
}

output {
  # Debug por consola (opcional, para ver si funciona al arrancar)
  # stdout { codec => rubydebug }

  # Envío a Elasticsearch
  if [type] == "cowrie" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "logstash-cowrie-%{+YYYY.MM.dd}"
    }
  }
  else if [type] == "dionaea" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "logstash-dionaea-%{+YYYY.MM.dd}"
    }
  }
  else {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "logstash-others-%{+YYYY.MM.dd}"
    }
  }
}
